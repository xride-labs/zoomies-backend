// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Better Auth required models
model Account {
  id                    String    @id @default(cuid())
  userId                String    @map("user_id")
  accountId             String    @map("account_id") // Provider's account ID or equal to userId for credentials
  providerId            String    @map("provider_id") // e.g., "credential", "google", "phone"
  accessToken           String?   @map("access_token") @db.Text
  refreshToken          String?   @map("refresh_token") @db.Text
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope                 String?
  idToken               String?   @map("id_token") @db.Text
  password              String? // For credential accounts
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("accounts")
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique // Session token
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String  @id @default(cuid())
  username      String? @unique
  name          String?
  email         String? @unique
  bloodType     String? @map("blood_type")
  emailVerified Boolean @default(false) @map("email_verified")
  image         String?
  phone         String? @unique // For mobile OTP
  phoneVerified Boolean @default(false) @map("phone_verified")

  // Profile fields
  bio               String?
  location          String?
  ridesCompleted    Int?      @map("rides_completed")
  bikeType          String?   @map("bike_type")
  bikeOwned         String?   @map("bike_owned") // e.g., "Yamaha YZF-R3"
  bikeOwnerSince    DateTime? @map("bike_owner_since")
  bikeOdometer      Int? // in kilometers
  bikeModifications String?   @map("bike_modifications") // e.g., JSON string of modifications
  bikeOwnerAge      Int?      @map("bike_owner_age") // in years
  xpPoints          Int?      @map("xp_points") // Experience points
  experienceLevel   String?   @map("experience_level") // e.g., Beginner, Intermediate, Expert
  levelOfActivity   String?   @map("level_of_activity") // e.g., Casual, Regular, Enthusiast
  reputationScore   Float?    @map("reputation_score") // e.g., 4.5 out of 5
  affiliations      String? // e.g., Clubs or groups the user is part of (as a JSON string)
  reminders         String? // e.g., JSON string of reminder settings

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Multi-role support (replaces single role field)
  userRoles UserRoleAssignment[]

  // Relations
  accounts            Account[]
  sessions            Session[]
  createdRides        Ride[]               @relation("RideCreator")
  rideParticipations  RideParticipant[]
  createdClubs        Club[]               @relation("ClubOwner")
  clubMemberships     ClubMember[]
  marketplaceListings MarketplaceListing[] @relation("SellerListings")
  chatMessages        ChatMessage[]
  posts               Post[]
  likes               Like[]
  comments            Comment[]
  followers           Follow[]             @relation("Following")
  following           Follow[]             @relation("Followers")
  receivedReviews     Review[]             @relation("ReviewReceiver")
  reportsFiled        Report[]             @relation("ReportReporter")

  @@map("users")
}

// Application-specific models for Phase 1 MVP

// User roles for role-based access control
enum UserRole {
  SUPER_ADMIN // Full platform access (web only)
  ADMIN // System administrator (web only)
  CLUB_OWNER // Club creator/manager (web + mobile)
  USER // Regular user (default, mobile only)
  RIDER // Active motorcycle rider (mobile only)
  SELLER // Marketplace seller (web + mobile)
}

// Many-to-many user role assignments (multi-role support)
model UserRoleAssignment {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  role       UserRole
  assignedAt DateTime @default(now()) @map("assigned_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@map("user_role_assignments")
}

// Media model for tracking uploaded files
model Media {
  id           String    @id @default(cuid())
  publicId     String    @unique @map("public_id") // Cloudinary public ID
  url          String
  secureUrl    String    @map("secure_url")
  thumbnailUrl String?   @map("thumbnail_url")
  type         MediaType
  format       String?
  width        Int?
  height       Int?
  bytes        Int?
  duration     Float? // For videos, in seconds
  folder       String // Cloudinary folder

  // Polymorphic associations
  userId    String? @map("user_id")
  clubId    String? @map("club_id")
  rideId    String? @map("ride_id")
  listingId String? @map("listing_id")
  postId    String? @map("post_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("media")
}

enum MediaType {
  IMAGE
  VIDEO
}

enum RideStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ClubMemberRole {
  MEMBER // Regular club member
  OFFICER // Club officer/moderator
  ADMIN // Club admin
  FOUNDER // Club founder
}

enum RideParticipantStatus {
  REQUESTED
  ACCEPTED
  DECLINED
  COMPLETED
  CANCELLED
}

model Ride {
  id              String     @id @default(cuid())
  title           String
  description     String?
  startLocation   String     @map("start_location")
  endLocation     String?    @map("end_location")
  experienceLevel String?    @map("experience_level") // e.g., Beginner, Intermediate, Expert
  xpRequired      Int?       @map("xp_required")
  pace            String? // e.g., Leisurely, Moderate, Fast
  distance        Float?
  duration        Int? // in minutes
  scheduledAt     DateTime?  @map("scheduled_at")
  endedAt         DateTime?  @map("ended_at") // When ride actually ended
  status          RideStatus @default(PLANNED)

  // Lifecycle management
  keepPermanently Boolean @default(false) @map("keep_permanently") // Prevent auto-deletion

  // Route data (for GPS tracking)
  routeData String?  @map("route_data") // JSON string of waypoints
  images    String[] // Array of image URLs

  // Chat fields
  chatGroupId String? @map("chat_group_id")
  chatLocked  Boolean @default(false) @map("chat_locked")

  // Creator relation
  creatorId String @map("creator_id")
  creator   User   @relation("RideCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  // Club relation (optional - for club-organized rides)
  clubId String? @map("club_id")

  // Participants relation
  participants RideParticipant[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("rides")
}

model Club {
  id            String    @id @default(cuid())
  name          String
  description   String?
  location      String?
  establishedAt DateTime? @map("established_at")
  verified      Boolean   @default(false)
  image         String?
  coverImage    String?   @map("cover_image")
  clubType      String?   @map("club_type") // e.g., Riding Club, Social Club
  isPublic      Boolean   @default(true) @map("is_public")
  memberCount   Int       @default(0) @map("member_count")
  trophies      String[] // Array of trophy names or IDs
  trophyCount   Int       @default(0) @map("trophy_count")
  gallery       String[] // Array of image URLs
  reputation    Float? // Average rating of the club

  ownerId String @map("owner_id")
  owner   User   @relation("ClubOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  // Members relation
  members ClubMember[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("clubs")
}

enum ListingStatus {
  ACTIVE
  SOLD
  INACTIVE
}

model MarketplaceListing {
  id             String        @id @default(cuid())
  title          String
  description    String?
  price          Float
  currency       String        @default("INR")
  images         String[] // Array of image URLs
  category       String? // e.g., Motorcycle, Gear, Accessories
  subcategory    String? // e.g., Helmet, Jacket
  specifications String? // e.g., JSON string of specifications
  condition      String?
  status         ListingStatus @default(ACTIVE)

  sellerId String @map("seller_id")
  seller   User   @relation("SellerListings", fields: [sellerId], references: [id], onDelete: Cascade)

  // Reviews relation
  reviews Review[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("marketplace_listings")
}

model ChatMessage {
  id          String   @id @default(cuid())
  chatGroupId String   @map("chat_group_id")
  senderId    String   @map("sender_id")
  content     String
  timestamp   DateTime @default(now())
  users       User[]

  @@map("chat_messages")
}

// Club membership model with roles
model ClubMember {
  id       String         @id @default(cuid())
  clubId   String         @map("club_id")
  userId   String         @map("user_id")
  role     ClubMemberRole @default(MEMBER)
  joinedAt DateTime       @default(now()) @map("joined_at")

  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@map("club_members")
}

// Ride participant model to track participation
model RideParticipant {
  id       String                @id @default(cuid())
  rideId   String                @map("ride_id")
  userId   String                @map("user_id")
  status   RideParticipantStatus @default(ACCEPTED)
  joinedAt DateTime              @default(now()) @map("joined_at")

  ride Ride @relation(fields: [rideId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([rideId, userId])
  @@map("ride_participants")
}

// Post model for the feed system
model Post {
  id      String   @id @default(cuid())
  type    String // "ride", "content", "listing", "club-activity"
  content String?
  images  String[] // Array of image URLs

  authorId String @map("author_id")
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Optional relations to other models
  rideId    String? @map("ride_id")
  listingId String? @map("listing_id")
  clubId    String? @map("club_id")

  // Interactions
  likes    Like[]
  comments Comment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("posts")
}

// Like model for posts
model Like {
  id     String @id @default(cuid())
  postId String @map("post_id")
  userId String @map("user_id")
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([postId, userId])
  @@map("likes")
}

// Comment model for posts
model Comment {
  id       String @id @default(cuid())
  postId   String @map("post_id")
  authorId String @map("author_id")
  content  String
  post     Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("comments")
}

// Follow model for user relationships
model Follow {
  id          String @id @default(cuid())
  followerId  String @map("follower_id")
  followingId String @map("following_id")

  follower  User @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([followerId, followingId])
  @@map("follows")
}

// Review/Rating model for marketplace listings
model Review {
  id         String  @id @default(cuid())
  listingId  String  @map("listing_id")
  reviewerId String  @map("reviewer_id")
  rating     Float // 1.0 to 5.0
  comment    String?

  listing  MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  reviewer User               @relation("ReviewReceiver", fields: [reviewerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([listingId, reviewerId])
  @@map("reviews")
}

model Report {
  id               String  @id @default(cuid())
  type             String
  title            String
  description      String?
  reportedItemId   String? @map("reported_item_id")
  reportedItemName String? @map("reported_item_name")
  reportedItemType String? @map("reported_item_type")
  status           String  @default("pending")
  priority         String  @default("medium")
  resolution       String?

  reporterId String? @map("reporter_id")
  reporter   User?   @relation("ReportReporter", fields: [reporterId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("reports")
}
