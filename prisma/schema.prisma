// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Better Auth required models
model Account {
  id                    String    @id @default(cuid())
  userId                String    @map("user_id")
  accountId             String    @map("account_id") // Provider's account ID or equal to userId for credentials
  providerId            String    @map("provider_id") // e.g., "credential", "google", "phone"
  accessToken           String?   @map("access_token") @db.Text
  refreshToken          String?   @map("refresh_token") @db.Text
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope                 String?
  idToken               String?   @map("id_token") @db.Text
  password              String? // For credential accounts
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("accounts")
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique // Session token
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  username      String?   @unique
  name          String?
  email         String?   @unique
  dob           DateTime? // Date of birth
  bloodType     String?   @map("blood_type") // e.g., "O+", "A-", "B+", "AB-"
  emailVerified Boolean   @default(false) @map("email_verified")
  avatar        String? // Profile picture URL
  coverImage    String?   @map("cover_image") // Cover/banner image URL
  phone         String?   @unique // For mobile OTP
  phoneVerified Boolean   @default(false) @map("phone_verified")

  // Profile fields
  bio      String?
  location String?

  // Experience system
  xpPoints        Int?   @default(0) @map("xp_points") // Total experience points
  level           Int    @default(1) // Current level (1-100)
  levelTitle      String @default("Beginner") @map("level_title") // e.g., "Road Warrior", "Highway Legend"
  reputationScore Float? @default(0) @map("reputation_score") // 0.0 to 5.0
  activityLevel   String @default("Casual") @map("activity_level") // e.g., "Casual", "Regular", "Enthusiast", "Pro"

  // Safety fields
  helmetVerified  Boolean   @default(false) @map("helmet_verified")
  lastSafetyCheck DateTime? @map("last_safety_check")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Multi-role support (replaces single role field)
  userRoles UserRoleAssignment[]

  // Relations
  accounts            Account[]
  sessions            Session[]
  createdRides        Ride[]               @relation("RideCreator")
  rideParticipations  RideParticipant[]
  createdClubs        Club[]               @relation("ClubOwner")
  clubMemberships     ClubMember[]
  clubJoinRequests    ClubJoinRequest[]
  marketplaceListings MarketplaceListing[] @relation("SellerListings")
  chatMessages        ChatMessage[]
  posts               Post[]
  likes               Like[]
  comments            Comment[]
  followers           Follow[]             @relation("Following")
  following           Follow[]             @relation("Followers")
  receivedReviews     Review[]             @relation("ReviewReceiver")
  reportsFiled        Report[]             @relation("ReportReporter")

  // New relations for comprehensive profile
  bikes             Bike[]
  badges            UserBadge[]
  emergencyContacts EmergencyContact[]
  preferences       UserPreferences?
  rideStats         UserRideStats?
  friendsInitiated  Friendship[]       @relation("FriendInitiator")
  friendsReceived   Friendship[]       @relation("FriendReceiver")

  @@map("users")
}

// Application-specific models for Phase 1 MVP

// User roles for role-based access control
enum UserRole {
  ADMIN // Super admin with full platform access (web + mobile)
  CLUB_OWNER // Club creator/manager (web + mobile)
  RIDER // Default role for new signups - active motorcycle rider (mobile)
  SELLER // Marketplace seller - assigned when user lists items (web + mobile)
}

// Many-to-many user role assignments (multi-role support)
model UserRoleAssignment {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  role       UserRole
  assignedAt DateTime @default(now()) @map("assigned_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@map("user_role_assignments")
}

// Media model for tracking uploaded files
model Media {
  id           String    @id @default(cuid())
  publicId     String    @unique @map("public_id") // Cloudinary public ID
  url          String
  secureUrl    String    @map("secure_url")
  thumbnailUrl String?   @map("thumbnail_url")
  type         MediaType
  format       String?
  width        Int?
  height       Int?
  bytes        Int?
  duration     Float? // For videos, in seconds
  folder       String // Cloudinary folder

  // Polymorphic associations
  userId    String? @map("user_id")
  clubId    String? @map("club_id")
  rideId    String? @map("ride_id")
  listingId String? @map("listing_id")
  postId    String? @map("post_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("media")
}

enum MediaType {
  IMAGE
  VIDEO
}

enum RideStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ClubMemberRole {
  MEMBER // Regular club member
  OFFICER // Club officer/moderator
  ADMIN // Club admin
  FOUNDER // Club founder
}

enum RideParticipantStatus {
  REQUESTED
  ACCEPTED
  DECLINED
  COMPLETED
  CANCELLED
}

model Ride {
  id              String     @id @default(cuid())
  title           String
  description     String?
  startLocation   String     @map("start_location")
  endLocation     String?    @map("end_location")
  experienceLevel String?    @map("experience_level") // e.g., Beginner, Intermediate, Expert
  xpRequired      Int?       @map("xp_required")
  pace            String? // e.g., Leisurely, Moderate, Fast
  distance        Float?
  duration        Int? // in minutes
  scheduledAt     DateTime?  @map("scheduled_at")
  endedAt         DateTime?  @map("ended_at") // When ride actually ended
  status          RideStatus @default(PLANNED)

  // Lifecycle management
  keepPermanently Boolean @default(false) @map("keep_permanently") // Prevent auto-deletion

  // Route data (for GPS tracking)
  routeData String?  @map("route_data") // JSON string of waypoints
  images    String[] // Array of image URLs

  // Chat fields
  chatGroupId String? @map("chat_group_id")
  chatLocked  Boolean @default(false) @map("chat_locked")

  // Creator relation
  creatorId String @map("creator_id")
  creator   User   @relation("RideCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  // Club relation (optional - for club-organized rides)
  clubId String? @map("club_id")

  // Participants relation
  participants RideParticipant[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("rides")
}

model Club {
  id            String    @id @default(cuid())
  name          String
  description   String?
  location      String?
  establishedAt DateTime? @map("established_at")
  verified      Boolean   @default(false)
  image         String?
  coverImage    String?   @map("cover_image")
  clubType      String?   @map("club_type") // e.g., Riding Club, Social Club
  isPublic      Boolean   @default(true) @map("is_public")
  memberCount   Int       @default(0) @map("member_count")
  trophies      String[] // Array of trophy names or IDs
  trophyCount   Int       @default(0) @map("trophy_count")
  gallery       String[] // Array of image URLs
  reputation    Float? // Average rating of the club

  ownerId String @map("owner_id")
  owner   User   @relation("ClubOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  // Members relation
  members      ClubMember[]
  joinRequests ClubJoinRequest[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("clubs")
}

enum ListingStatus {
  ACTIVE
  SOLD
  INACTIVE
}

model MarketplaceListing {
  id             String        @id @default(cuid())
  title          String
  description    String?
  price          Float
  currency       String        @default("INR")
  images         String[] // Array of image URLs
  category       String? // e.g., Motorcycle, Gear, Accessories
  subcategory    String? // e.g., Helmet, Jacket
  specifications String? // e.g., JSON string of specifications
  condition      String?
  status         ListingStatus @default(ACTIVE)

  sellerId String @map("seller_id")
  seller   User   @relation("SellerListings", fields: [sellerId], references: [id], onDelete: Cascade)

  // Reviews relation
  reviews Review[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("marketplace_listings")
}

model ChatMessage {
  id          String   @id @default(cuid())
  chatGroupId String   @map("chat_group_id")
  senderId    String   @map("sender_id")
  content     String
  timestamp   DateTime @default(now())
  users       User[]

  @@map("chat_messages")
}

// Club membership model with roles
model ClubMember {
  id       String         @id @default(cuid())
  clubId   String         @map("club_id")
  userId   String         @map("user_id")
  role     ClubMemberRole @default(MEMBER)
  joinedAt DateTime       @default(now()) @map("joined_at")

  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@map("club_members")
}

// Club join request for private clubs or moderated joins
model ClubJoinRequest {
  id        String                @id @default(cuid())
  clubId    String                @map("club_id")
  userId    String                @map("user_id")
  message   String? // Optional message from the requester
  status    ClubJoinRequestStatus @default(PENDING)
  createdAt DateTime              @default(now()) @map("created_at")
  updatedAt DateTime              @updatedAt @map("updated_at")

  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@map("club_join_requests")
}

enum ClubJoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// Ride participant model to track participation
model RideParticipant {
  id       String                @id @default(cuid())
  rideId   String                @map("ride_id")
  userId   String                @map("user_id")
  status   RideParticipantStatus @default(ACCEPTED)
  joinedAt DateTime              @default(now()) @map("joined_at")

  ride Ride @relation(fields: [rideId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([rideId, userId])
  @@map("ride_participants")
}

// Post model for the feed system
model Post {
  id      String   @id @default(cuid())
  type    String // "ride", "content", "listing", "club-activity"
  content String?
  images  String[] // Array of image URLs

  authorId String @map("author_id")
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Optional relations to other models
  rideId    String? @map("ride_id")
  listingId String? @map("listing_id")
  clubId    String? @map("club_id")

  // Interactions
  likes    Like[]
  comments Comment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("posts")
}

// Like model for posts
model Like {
  id     String @id @default(cuid())
  postId String @map("post_id")
  userId String @map("user_id")
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([postId, userId])
  @@map("likes")
}

// Comment model for posts
model Comment {
  id       String @id @default(cuid())
  postId   String @map("post_id")
  authorId String @map("author_id")
  content  String
  post     Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("comments")
}

// Follow model for user relationships
model Follow {
  id          String @id @default(cuid())
  followerId  String @map("follower_id")
  followingId String @map("following_id")

  follower  User @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([followerId, followingId])
  @@map("follows")
}

// Review/Rating model for marketplace listings
model Review {
  id         String  @id @default(cuid())
  listingId  String  @map("listing_id")
  reviewerId String  @map("reviewer_id")
  rating     Float // 1.0 to 5.0
  comment    String?

  listing  MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  reviewer User               @relation("ReviewReceiver", fields: [reviewerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([listingId, reviewerId])
  @@map("reviews")
}

model Report {
  id               String  @id @default(cuid())
  type             String
  title            String
  description      String?
  reportedItemId   String? @map("reported_item_id")
  reportedItemName String? @map("reported_item_name")
  reportedItemType String? @map("reported_item_type")
  status           String  @default("pending")
  priority         String  @default("medium")
  resolution       String?

  reporterId String? @map("reporter_id")
  reporter   User?   @relation("ReportReporter", fields: [reporterId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("reports")
}

// ============================================
// USER PROFILE ENHANCEMENT MODELS
// ============================================

// Bike model for user's motorcycles
enum BikeType {
  SPORT
  CRUISER
  TOURING
  ADVENTURE
  NAKED
  CAFE_RACER
  DUAL_SPORT
  SCOOTER
  COMMUTER
  SUPERBIKE
  OTHER
}

model Bike {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  make         String // e.g., "Yamaha", "Honda", "Royal Enfield"
  model        String // e.g., "R15 V4", "Meteor 350"
  year         Int // e.g., 2023
  type         BikeType  @default(OTHER)
  engineCc     Int?      @map("engine_cc") // Engine displacement in cc
  color        String?
  licensePlate String?   @map("license_plate")
  vin          String? // Vehicle Identification Number
  odo          Int       @default(0) // Odometer reading in km
  ownerSince   DateTime? @map("owner_since")
  isPrimary    Boolean   @default(false) @map("is_primary")
  image        String? // Bike image URL

  // Modifications stored as JSON
  modifications Json? // { exhaust, tyres, lights, phoneMount, etc. }

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("bikes")
}

// Badge definitions (master list of all badges)
model Badge {
  id          String  @id @default(cuid())
  title       String  @unique // e.g., "First Ride", "1000 KM Club"
  description String?
  icon        String? // Emoji or icon URL
  auraPoints  Int     @default(0) @map("aura_points") // XP/Aura points awarded
  category    String? // e.g., "distance", "social", "achievement"
  requirement String? // Description of how to earn this badge

  // Users who have earned this badge
  users UserBadge[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("badges")
}

// Junction table for users and their earned badges
model UserBadge {
  id       String   @id @default(cuid())
  userId   String   @map("user_id")
  badgeId  String   @map("badge_id")
  earnedAt DateTime @default(now()) @map("earned_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@map("user_badges")
}

// Emergency contacts for user safety
model EmergencyContact {
  id           String  @id @default(cuid())
  userId       String  @map("user_id")
  name         String
  phone        String
  relationship String? // e.g., "Spouse", "Parent", "Friend", "Sibling"
  isPrimary    Boolean @default(false) @map("is_primary")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("emergency_contacts")
}

// User preferences for app settings
model UserPreferences {
  id                String  @id @default(cuid())
  userId            String  @unique @map("user_id")
  rideReminders     Boolean @default(true) @map("ride_reminders")
  serviceReminderKm Int     @default(3000) @map("service_reminder_km")
  darkMode          Boolean @default(false) @map("dark_mode")
  units             String  @default("metric") // "metric" or "imperial"
  openToInvite      Boolean @default(true) @map("open_to_invite")

  // Notification preferences
  pushNotifications  Boolean @default(true) @map("push_notifications")
  emailNotifications Boolean @default(true) @map("email_notifications")
  smsNotifications   Boolean @default(false) @map("sms_notifications")

  // Privacy settings
  profileVisibility String  @default("public") @map("profile_visibility") // "public", "friends", "private"
  showLocation      Boolean @default(true) @map("show_location")
  showBikes         Boolean @default(true) @map("show_bikes")
  showStats         Boolean @default(true) @map("show_stats")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_preferences")
}

// User ride statistics (aggregated data)
model UserRideStats {
  id                String @id @default(cuid())
  userId            String @unique @map("user_id")
  totalDistanceKm   Int    @default(0) @map("total_distance_km")
  longestRideKm     Int    @default(0) @map("longest_ride_km")
  totalRides        Int    @default(0) @map("total_rides")
  nightRides        Int    @default(0) @map("night_rides")
  weekendRides      Int    @default(0) @map("weekend_rides")
  soloRides         Int    @default(0) @map("solo_rides")
  groupRides        Int    @default(0) @map("group_rides")
  avgRideDistanceKm Float  @default(0) @map("avg_ride_distance_km")
  totalRideTimeMin  Int    @default(0) @map("total_ride_time_min") // Total time in minutes

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_ride_stats")
}

// Friendship model for mutual connections (different from followers)
enum FriendshipStatus {
  PENDING
  ACCEPTED
  DECLINED
  BLOCKED
}

model Friendship {
  id         String           @id @default(cuid())
  senderId   String           @map("sender_id")
  receiverId String           @map("receiver_id")
  status     FriendshipStatus @default(PENDING)

  sender   User @relation("FriendInitiator", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("FriendReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([senderId, receiverId])
  @@map("friendships")
}
